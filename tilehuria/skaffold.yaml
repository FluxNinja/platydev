apiVersion: skaffold/v2beta8
kind: Config
build:
  tagPolicy:
    sha256: {}
  artifacts:
    - image: tilehuria-web
      context: ..
      docker:
        dockerfile: tilehuria/web/Dockerfile
    - image: tilehuria-worker
      context: ..
      docker:
        dockerfile: tilehuria/worker/Dockerfile
    - image: tilehuria-hooks
      context: ..
      docker:
        dockerfile: tilehuria/hooks/Dockerfile
    - image: tilehuria-hasura
      context: hasura
    - image: tilehuria-hasura-backend-plus
      context: hasura-backend-plus
deploy:
  helm:
    releases:
      - name: tilehuria
        chartPath: helm
        skipBuildDependencies: false
        artifactOverrides:
          web:
            image: tilehuria-web
          hasura:
            image: tilehuria-hasura
          hasura-backend-plus:
            image: tilehuria-hasura-backend-plus
          worker:
            image: tilehuria-worker
          hooks:
            image: tilehuria-hooks
profiles:
  - name: dev
    activation:
      - command: dev
    build:
      tagPolicy:
        sha256: {}
      artifacts:
        - image: tilehuria-web
          context: ..
          docker:
            dockerfile: tilehuria/web/Dockerfile-development
          sync:
            manual:
              - src: tilehuria/web/public/**/*
                dest: .
              - src: tilehuria/web/src/**/*.{ts,vue,json,sass,html}
                dest: .
              - src: tilehuria/web/quasar.conf.js
                dest: .
              - src: tilehuria/web/src/assets/**/*
                dest: .
        - image: tilehuria-worker
          context: ..
          docker:
            dockerfile: tilehuria/worker/Dockerfile-development
          sync:
            manual:
              - src: tilehuria/worker/src/**/*.{ts,json}
                dest: .
        - image: tilehuria-hooks
          context: ..
          docker:
            dockerfile: tilehuria/hooks/Dockerfile-development
          sync:
            manual:
              - src: tilehuria/hooks/src/**/*.{ts,json}
                dest: .
        - image: tilehuria-hasura
          context: hasura
          sync:
            manual:
              - src: migrations/**/*
                dest: .
              - src: metadata/*
                dest: .
    deploy:
      helm:
        releases:
          - name: tilehuria
            chartPath: helm
            skipBuildDependencies: false
            artifactOverrides:
              web:
                image: tilehuria-web
              worker:
                image: tilehuria-worker
              hooks:
                image: tilehuria-hooks
              hasura:
                image: tilehuria-hasura
            setValues:
              hasura:
                postgresql:
                  postgresqlPassword: development-postgres-password
                adminSecret: development-hasura-admin-secret
                jwt:
                  key: long-hasura-jwt-more-than-thirty-two-characters
                  algorithm: HS256
                ingress:
                  enabled: true
                  "hosts[0].name": hasura.localhost
              rabbitmq:
                auth:
                  username: user
                  password: long-and-secret-rabbitmq-password
              traefik:
                enabled: true
              global:
                ingress:
                  enabled: true
                  domain: localhost
              web:
                targetPort: 8080
                ingress:
                  enabled: true
                  "hosts[0].name": web.localhost
              hasura-backend-plus:
                ingress:
                  enabled: true
                  "hosts[0].name": hasura-backend-plus.localhost
              worker:
                ingress:
                  enabled: true
                  "hosts[0].name": worker.localhost
              hooks:
                ingress:
                  enabled: true
                  "hosts[0].name": hooks.localhost
